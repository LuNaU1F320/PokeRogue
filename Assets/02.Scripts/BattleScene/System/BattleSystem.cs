using System.Collections;
using System;
using UnityEngine;
using System.Linq;
using UnityEngine.UI;
using System.Collections.Generic;

public enum BattleAction
{
    Skill,
    SwitchPokemon,
    UseItem,
    Run
}
public enum BattleState
{
    None,
    Start,
    Action,
    Skill,
    RunningTurn,
    Busy,
    PartyScreen,
    SkillToForget,
    ConfirmBox,
    Evolution,
    BattleOver,
    ConfigSelection,
    Dialog
}
public class BattleSystem : MonoBehaviour
{
    public static BattleSystem Inst;
    [SerializeField] public BattleUnit playerUnit;
    [SerializeField] public BattleUnit enemyUnit;
    BattleDialogBox dialogBox;
    // [SerializeField] ConfigPanel configPanel;
    [SerializeField] GameObject Pokeball;
    // [SerializeField] GameObject ConfirmBox;

    //Party
    // [SerializeField] PartyScreen partyScreen;
    // [SerializeField] SkillSelectScreen skillSelectScreen;

    // [HideInInspector] public static BattleState state;
    BattleState preState;
    // int currentAction = 0;
    // int currentSkill = 0;
    // int currentMember = 0;
    // int currentSelection = 0;
    // int currentConfirm = 0;
    int escapeAttempts = 0;

    PokemonParty playerParty;
    PokemonParty trainerParty;
    Pokemon wildPokemon;
    bool isTrainerBattle = false;

    PlayerCtrl player;
    Image PlayerImage;
    TrainerCtrl trainer;

    SkillBase skillToLearn;

    private void Awake()
    {
        Inst = this;

        player = GameManager.Inst.playerCtrl;
        dialogBox = GameManager.Inst.dialogBox;
    }
    private void Start()
    {
        // state = BattleState.Start;
        // currentAction = 0;
        // PlayerImage.sprite = player.TrainerSprite;
        // PlayerImage.gameObject.SetActive(false);
    }
    public void StartBattle(PokemonParty playerParty, Pokemon wildPokemon)
    {
        GameManager.state = BattleState.Start;
        isTrainerBattle = false;
        this.playerParty = playerParty;
        this.wildPokemon = wildPokemon;
        StartCoroutine(SetUpBattle());
    }
    public void StartTrainerBattle(PokemonParty playerParty, PokemonParty trainerParty)
    {
        this.playerParty = playerParty;
        this.trainerParty = trainerParty;

        isTrainerBattle = true;

        player = playerParty.GetComponent<PlayerCtrl>();
        trainer = trainerParty.GetComponent<TrainerCtrl>();

        StartCoroutine(SetUpBattle());
    }
    /*
    public void Update()
    {
        if (state == BattleState.BattleOver || state == BattleState.Evolution)
        {
            return;
        }
        if (state == BattleState.ActionSelection)
        {
            HandleActionSelection();
        }
        else if (state == BattleState.SkillSelection)
        {
            HandleSkillSelection();
        }
        else if (state == BattleState.PartyScreen)
        {
            HandlePartyScreenSelection();
        }
        else if (state == BattleState.SkillToForget)
        {
            HandleLearnSkillSelection();
        }
        else if (state == BattleState.ConfirmBox)
        {
            HandleConfirmBoxSelection();
        }

        if (Input.GetKeyDown(KeyCode.Escape))
        {
            if (state == BattleState.ConfigSelection)
            {
                if (configPanel.state == ConfigState.Config_Right)
                {
                    if (Input.GetKeyDown(KeyCode.Escape))
                    {
                        configPanel.gameObject.SetActive(false);
                        state = preState;
                    }
                }
            }
            else
            {
                configPanel.gameObject.SetActive(true);
                preState = state;
                state = BattleState.ConfigSelection;
            }
        }
        if (Input.GetKeyDown(KeyCode.G))
        {
            Debug.Log(currentMember);
        }
        if (Input.GetKeyDown(KeyCode.F))
        {
            Debug.Log(playerUnit.BattlePokemon.Attack);
            Debug.Log(playerUnit.BattlePokemon.Rankup[0]);
        }
        if (Input.GetKeyDown(KeyCode.T))
        {
            Debug.Log($"{playerUnit.BattlePokemon.PokemonGen}");
        }
    }
*/
    public IEnumerator SetUpBattle()
    {
        if (isTrainerBattle == false)
        {
            playerUnit.SetUp(playerParty.GetHealthyPokemon());
            enemyUnit.SetUp(wildPokemon);

            dialogBox.SetSkillNames(playerUnit.BattlePokemon.Skills);
            GameManager.Inst.skillCount = playerUnit.BattlePokemon.Skills.Count;
            yield return dialogBox.TypeDialog($"Ïïó! ÏïºÏÉù {enemyUnit.BattlePokemon.P_Base.PokemonName}{GetCorrectParticle(enemyUnit.BattlePokemon.P_Base.PokemonName, "subject")} \nÌäÄÏñ¥ÎÇòÏôîÎã§!");
        }
        else
        {
            playerUnit.gameObject.SetActive(false);
            enemyUnit.gameObject.SetActive(false);

            PlayerImage.gameObject.SetActive(true);
            // PlayerImage.gameObject.SetActive(true);

            PlayerImage.sprite = player.TrainerSprite;
            // PlayerImage.sprite = trainer.TrainerSprite;

            yield return dialogBox.TypeDialog($"{trainer.TrainerName}{/*ÏùÄÎäîÏù¥Í∞Ä*/""}Ïù¥ Î∞∞ÌãÄÏùÑ Í±∏Ïñ¥ÏôîÎã§!");
        }
        escapeAttempts = 0;
        GameManager.Inst.partyScreen.Init();
        GameManager.Inst.ActionSelection();
    }
    void BattleOver(bool won)
    {
        if (GameManager.state == BattleState.Dialog)
        {
            StartCoroutine(new WaitUntil(() => GameManager.state != BattleState.Dialog));
            GameManager.state = BattleState.BattleOver;
        }
        GameManager.state = BattleState.BattleOver;
        StopAllCoroutines();
        GameManager.Inst.EndBattle(won);
    }
    void ChooseSkillToForget(Pokemon pokemon, SkillBase newSkill)
    {
        GameManager.state = BattleState.Busy;
        StartCoroutine(dialogBox.TypeDialog($"Ïñ¥Îäê Í∏∞Ïà†ÏùÑ ÏûäÍ≤å ÌïòÍ≥†Ïã∂ÏùÄÍ∞Ä?"));
        GameManager.Inst.skillSelectScreen.gameObject.SetActive(true);
        GameManager.Inst.skillSelectScreen.SetPokemonData(pokemon);
        GameManager.Inst.skillSelectScreen.SetSkill(pokemon.Skills.Select(x => x.SkillBase).ToList(), newSkill);
        skillToLearn = newSkill;

        GameManager.state = BattleState.SkillToForget;
    }

    #region BattleSystem
    public IEnumerator RunTurns(BattleAction playerAction)
    {
        GameManager.state = BattleState.RunningTurn;
        if (playerAction == BattleAction.Skill)
        {
            playerUnit.BattlePokemon.CurrentSkill = playerUnit.BattlePokemon.Skills[GameManager.Inst.currentSkill];
            enemyUnit.BattlePokemon.CurrentSkill = enemyUnit.BattlePokemon.GetRandomSkill();

            if (playerUnit.BattlePokemon.CurrentSkill == null || enemyUnit.BattlePokemon.CurrentSkill == null)
            {
                yield break;
            }
            int playerPriority = playerUnit.BattlePokemon.CurrentSkill.SkillBase.Priority;
            int enemyPriority = enemyUnit.BattlePokemon.CurrentSkill.SkillBase.Priority;

            int playerSpeed = playerUnit.BattlePokemon.Speed;
            int enemySpeed = enemyUnit.BattlePokemon.Speed;

            Debug.Log($"üïäÔ∏è ÌîåÎ†àÏù¥Ïñ¥ Ïä§ÌÇ¨ Ïö∞ÏÑ†ÎèÑ: {playerPriority}, ÏÜçÎèÑ: {playerSpeed}");
            Debug.Log($"üêç Ï†Å Ïä§ÌÇ¨ Ïö∞ÏÑ†ÎèÑ: {enemyPriority}, ÏÜçÎèÑ: {enemySpeed}");

            // Ïä§ÌîºÎìú Ï≤¥ÌÅ¨
            bool playerTurnFirst = true;
            //Ïö∞ÏÑ†ÎèÑ Ï≤¥ÌÅ¨
            if (enemyPriority > playerPriority)
            {
                playerTurnFirst = false;
            }
            else if (playerPriority == enemyPriority)
            {
                if (playerSpeed == enemySpeed)
                {
                    playerTurnFirst = UnityEngine.Random.Range(0, 2) == 0;
                }
                else
                {
                    playerTurnFirst = playerSpeed > enemySpeed;
                }
            }

            var firstUnit = playerTurnFirst ? playerUnit : enemyUnit;
            var secondUnit = playerTurnFirst ? enemyUnit : playerUnit;

            var targetOfFirst = secondUnit;
            var targetOfSecond = firstUnit;

            // 1. ÏÑ†Í≥µÏûê ÌñâÎèô
            yield return RunSkill(firstUnit, targetOfFirst, firstUnit.BattlePokemon.CurrentSkill);
            yield return RunAfterTrun(firstUnit);

            if (GameManager.state == BattleState.BattleOver)
            {
                yield break;
            }
            // ÏÑ†Í≥µÏûêÍ∞Ä Í≥µÍ≤©Ìïú ÎåÄÏÉÅ Ïì∞Îü¨Ïßê ÌôïÏù∏
            if (targetOfFirst.BattlePokemon == null || targetOfFirst.BattlePokemon.PokemonHp <= 0)
            {
                Debug.Log("‚õî Îí§Ïßê");
                yield return HandlePokemonFainted(targetOfFirst);
                yield return CheckForBattleOver(targetOfFirst);
                yield break;
            }

            // 2. ÌõÑÍ≥µÏûê ÌñâÎèô (ÏûêÍ∏∞ÏôÄ ÎåÄÏÉÅ Î™®Îëê ÏÇ¥ÏïÑ ÏûàÏùÑ ÎïåÎßå)
            if (secondUnit.BattlePokemon != null && secondUnit.BattlePokemon.PokemonHp > 0 && targetOfSecond.BattlePokemon != null && targetOfSecond.BattlePokemon.PokemonHp > 0)
            {
                yield return RunSkill(secondUnit, targetOfSecond, secondUnit.BattlePokemon.CurrentSkill);
                yield return RunAfterTrun(secondUnit);

                if (GameManager.state == BattleState.BattleOver)
                {
                    yield break;
                }
                if (targetOfSecond.BattlePokemon != null && targetOfSecond.BattlePokemon.PokemonHp <= 0)
                {
                    yield return HandlePokemonFainted(targetOfSecond);
                    yield return CheckForBattleOver(targetOfSecond);
                    yield break;
                }
            }
            else
            {
                Debug.Log("‚õî ÌõÑÍ≥µÏûê ÎòêÎäî ÎåÄÏÉÅÏù¥ Ïì∞Îü¨ÏßÑ ÏÉÅÌÉú. ÌõÑÍ≥µ ÌñâÎèô ÏÉùÎûµ.");
                yield break;
            }
        }
        //Ïä§ÌÇ¨ Ïô∏ ÌñâÎèô
        else
        {
            Debug.Log($"‚ñ∂ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä {playerAction} ÏÑ†ÌÉù");

            if (playerAction == BattleAction.SwitchPokemon)
            {
                var selectedPokemon = playerParty.Party[GameManager.Inst.currentMember];
                preState = BattleState.RunningTurn;
                GameManager.state = BattleState.Busy;
                yield return SwitchPokemon(selectedPokemon);
            }
            else if (playerAction == BattleAction.UseItem)
            {
                preState = GameManager.state;
                GameManager.state = BattleState.Busy;
                dialogBox.EnableActionSelector(false);
                yield return ThrowPokeball();
            }
            else if (playerAction == BattleAction.Run)
            {
                preState = GameManager.state;
                GameManager.state = BattleState.Busy;
                yield return TryToRun();
            }

            if (GameManager.state == BattleState.BattleOver)
            {
                Debug.Log("üèÅ ÏïÑÏù¥ÌÖú/ÍµêÏ≤¥/ÎèÑÎßù ÌõÑ Ï†ÑÌà¨ Ï¢ÖÎ£åÎê®");
                yield break;
            }

            // Ï†Å ÌÑ¥
            var enemySkill = enemyUnit.BattlePokemon.GetRandomSkill();

            if (enemyUnit.BattlePokemon == null || enemyUnit.BattlePokemon.PokemonHp <= 0)
            {
                Debug.LogWarning("‚ùó Ï†Å Ìè¨ÏºìÎ™¨Ïù¥ Ïì∞Îü¨Ï°åÏùå. Ï†Å ÌÑ¥ Ïä§ÌÇµ.");
            }
            else
            {
                yield return RunSkill(enemyUnit, playerUnit, enemySkill);
                yield return RunAfterTrun(enemyUnit);

                if (GameManager.state == BattleState.BattleOver)
                {
                    Debug.Log("üèÅ Ï†Å ÌÑ¥ Ï¢ÖÎ£å ÌõÑ Ï†ÑÌà¨ Ï¢ÖÎ£åÎê®");
                }

                if (playerUnit.BattlePokemon.PokemonHp <= 0)
                {
                    Debug.Log("‚ö†Ô∏è ÌîåÎ†àÏù¥Ïñ¥ Ìè¨ÏºìÎ™¨ Ïì∞Îü¨Ïßê");
                    yield return HandlePokemonFainted(playerUnit);
                    yield return CheckForBattleOver(playerUnit);
                    yield break;
                }
            }
        }

        //Í≥ÑÏÜç ÌÑ¥ ÏßÑÌñâ
        if (GameManager.state != BattleState.BattleOver)
        {
            // Debug.Log("‚úÖ RunTurns Ï¢ÖÎ£å");
            GameManager.Inst.ActionSelection();
        }
    }
    IEnumerator RunSkill(BattleUnit sourceUnit, BattleUnit targetUnit, Skill skill)
    {
        bool canRunSkill = sourceUnit.BattlePokemon.OnBeforeSkill();
        if (canRunSkill == false)
        {
            yield return ShowStatusChanges(sourceUnit.BattlePokemon);
            yield return sourceUnit.BattleHud.UpdateHp();
            yield break;
        }
        yield return ShowStatusChanges(sourceUnit.BattlePokemon);

        //Í≥µÍ≤© Ïï†ÎãàÎ©îÏù¥ÏÖò
        skill.PP--;

        yield return dialogBox.TypeDialog($"{sourceUnit.BattlePokemon.P_Base.PokemonName}Ïùò {skill.SkillBase.SkillName}!");
        if (CheckSkillHits(skill, sourceUnit.BattlePokemon, targetUnit.BattlePokemon))
        {
            //Î≥ÄÌôîÍ∏∞ Ï≤òÎ¶¨
            if (skill.SkillBase.CategoryKey == CategoryKey.Status)
            {
                //Ï§ëÎ≥µ ÏÉÅÌÉúÏù¥ÏÉÅ Ï≤¥ÌÅ¨
                if (targetUnit.BattlePokemon.Status != null)
                {
                    yield return dialogBox.TypeDialog("Ìö®Í≥ºÍ∞Ä ÏóÜÎäî Í≤É Í∞ôÎã§...");
                }
                else
                {
                    yield return RunSkillEffects(skill.SkillBase.Effects, sourceUnit.BattlePokemon, targetUnit.BattlePokemon, skill.SkillBase.Target);
                }
            }
            else
            {
                //ÌîºÍ≤© Ïï†ÎãàÎ©îÏù¥ÏÖò
                targetUnit.PlayHitAnimation();
                var (startHp, endHp, damageDetails) = targetUnit.BattlePokemon.TakeDamage(skill, sourceUnit.BattlePokemon);

                StartCoroutine(targetUnit.BattleHud.UpdateHp());
                yield return ShowDamageDetails(damageDetails);
            }
            //Ï∂îÍ∞ÄÌö®Í≥º Ï°¥Ïû¨ Ïãú
            if (skill.SkillBase.SecondaryEffects != null && skill.SkillBase.SecondaryEffects.Count > 0 && targetUnit.BattlePokemon.PokemonHp > 0)
            {
                foreach (var secondary in skill.SkillBase.SecondaryEffects)
                {
                    var rnd = UnityEngine.Random.Range(1, 101);
                    if (rnd <= secondary.Chance)
                    {
                        yield return RunSkillEffects(secondary, sourceUnit.BattlePokemon, targetUnit.BattlePokemon, secondary.Target);
                    }
                }
            }
            if (targetUnit.BattlePokemon.PokemonHp <= 0)
            {
                yield return HandlePokemonFainted(targetUnit);
            }
        }
        else
        {
            if (sourceUnit.IsPlayerUnit)
            {
                yield return dialogBox.TypeDialog($"ÏÉÅÎåÄ {targetUnit.BattlePokemon.P_Base.PokemonName}ÏóêÍ≤åÎäî \nÎßûÏßÄ ÏïäÏïòÎã§!");
            }
            else
            {
                yield return dialogBox.TypeDialog($"{targetUnit.BattlePokemon.P_Base.PokemonName}ÏóêÍ≤åÎäî ÎßûÏßÄ ÏïäÏïòÎã§!");
            }
        }
    }
    IEnumerator RunAfterTrun(BattleUnit sourceUnit)
    {
        if (GameManager.state == BattleState.BattleOver)
        {
            yield break;
        }

        yield return new WaitUntil(() => GameManager.state == BattleState.RunningTurn);
        yield return new WaitForSeconds(1.2f);

        sourceUnit.BattlePokemon.OnAfterTurn();

        yield return ShowStatusChanges(sourceUnit.BattlePokemon);
        yield return sourceUnit.BattleHud.UpdateHp();

        //ÏÉÅÌÉúÏù¥ÏÉÅ Îç∞ÎØ∏ÏßÄÎ°ú Ï£ΩÏúºÎ©¥ @@@@
        if (sourceUnit.BattlePokemon.PokemonHp <= 0)
        {
            yield return HandlePokemonFainted(sourceUnit);
            yield return new WaitUntil(() => GameManager.state == BattleState.RunningTurn);
            // yield return dialogBox.TypeDialog($"{sourceUnit.BattlePokemon.PokemonBase.PokemonName}{GetCorrectParticle(sourceUnit.BattlePokemon.PokemonBase.PokemonName, false)} Ïì∞Îü¨Ï°åÎã§!");
            // /*
            // ÏÇ¨Îßù Ïï†ÎãàÎ©îÏù¥ÏÖò Ïû¨ÏÉù

            // */

            // yield return new WaitForSeconds(2.0f);
        }

        yield return new WaitForSeconds(1.0f);

    }
    //ÏÉÅÌÉúÏù¥ÏÉÅ, Îû≠ÌÅ¨ÏóÖ Ï≤òÎ¶¨
    IEnumerator RunSkillEffects(SkillEffects effects, Pokemon sourceUnit, Pokemon targetUnit, SkillTarget skillTarget)
    {
        //RankUp
        if (effects.Rankup != null)
        {
            if (skillTarget == SkillTarget.Self)
            {
                sourceUnit.ApplyRankups(effects.Rankup);
            }
            else
            {
                targetUnit.ApplyRankups(effects.Rankup);
            }
        }
        //ÏÉÅÌÉúÏù¥ÏÉÅ
        if (effects.Status != ConditionID.None)
        {
            targetUnit.SetStatus(effects.Status);
        }
        //ÏùºÏãú ÏÉÅÌÉúÏù¥ÏÉÅ
        if (effects.VolatileStatus != ConditionID.None)
        {
            targetUnit.SetVolatileStatus(effects.VolatileStatus);
        }

        yield return ShowStatusChanges(sourceUnit);
        yield return ShowStatusChanges(targetUnit);
    }
    //Î™ÖÏ§ëÎ•† Í≥ÑÏÇ∞
    bool CheckSkillHits(Skill skill, Pokemon source, Pokemon target)
    {
        if (skill.SkillBase.AlwaysHits)
        {
            return true;
        }
        float SkillAccuracy = skill.SkillBase.SkillAccuracy;
        int accuracy = source.Rankup[Stat.Accuracy];
        int evasion = target.Rankup[Stat.Evasion];

        var rankupValues = new float[] { 1f, 1.5f, 2f, 2.5f, 3f, 3.5f, 4f };

        if (accuracy > 0)
        {
            SkillAccuracy *= rankupValues[accuracy];
        }
        else
        {
            SkillAccuracy /= rankupValues[-accuracy];
        }
        if (evasion > 0)
        {
            SkillAccuracy /= rankupValues[evasion];
        }
        else
        {
            SkillAccuracy *= rankupValues[-evasion];
        }


        return UnityEngine.Random.Range(1, 101) <= SkillAccuracy;
    }
    //Îû≠ÌÅ¨ÏóÖ Î©îÏãúÏßÄ Ï∂úÎ†•
    IEnumerator ShowStatusChanges(Pokemon pokemon)
    {
        while (pokemon.StatusCngMsg.Count > 0)
        {
            string message = pokemon.StatusCngMsg.Dequeue();
            yield return dialogBox.TypeDialog(message);
        }
    }
    IEnumerator HandlePokemonFainted(BattleUnit faintedUnit)
    {
        yield return dialogBox.TypeDialog($"{faintedUnit.BattlePokemon.P_Base.PokemonName}{GetCorrectParticle(faintedUnit.BattlePokemon.P_Base.PokemonName, "topic")} Ïì∞Îü¨Ï°åÎã§!");
        //ÏÇ¨Îßù Ïï†ÎãàÎ©îÏù¥ÏÖò Ïû¨ÏÉù @@@@
        yield return new WaitForSeconds(1.5f);
        //ÌîåÎ†àÏù¥Ïñ¥ ÏäπÎ¶¨
        if (!faintedUnit.IsPlayerUnit)
        {
            int expYield = faintedUnit.BattlePokemon.P_Base.ExpYield;
            int enemyLevel = faintedUnit.BattlePokemon.PokemonLevel;
            float trainerBonus = (isTrainerBattle) ? 1.5f : 1.0f;

            int expGain = Mathf.FloorToInt(expYield * enemyLevel * trainerBonus / 7);
            playerUnit.BattlePokemon.PokemonExp += expGain;
            yield return playerUnit.BattleHud.SetExpSmooth();
            yield return dialogBox.TypeDialog($"{playerUnit.BattlePokemon.P_Base.PokemonName}{GetCorrectParticle(playerUnit.BattlePokemon.P_Base.PokemonName, "topic")}\n{expGain}Í≤ΩÌóòÏπòÎ•º ÏñªÏóàÎã§!");
            yield return CheckLearnableSkill();
        }
        yield return CheckForBattleOver(faintedUnit);
        GameManager.Inst.AddGold();
    }
    public IEnumerator SwitchPokemon(Pokemon newPokemon)
    {
        playerUnit.BattlePokemon.CureVolatileStatus();
        playerUnit.BattlePokemon.ResetRankup();

        yield return dialogBox.TypeDialog($"ÎèåÏïÑÏôÄ {playerUnit.BattlePokemon.P_Base.PokemonName}!");
        //Í∑ÄÌôò Ïï†ÎãàÎ©îÏù¥ÏÖò@@@

        yield return new WaitForSeconds(1.5f);

        // ÌòÑÏû¨ Ï†ÑÌà¨ Ï§ëÏù∏ Ìè¨ÏºìÎ™¨ (Ïù∏Îç±Ïä§ 0Ïóê ÏûàÎäî Ìè¨ÏºìÎ™¨)
        var currentBattlePokemon = playerParty.Party[0];

        // ÍµêÏ≤¥ ÏûëÏóÖ: ÍµêÏ≤¥Ìï† Ìè¨ÏºìÎ™¨ÏùÑ 0Î≤à Ïù∏Îç±Ïä§Î°ú, ÎÇòÍ∞ÄÏûàÎäî Ìè¨ÏºìÎ™¨ÏùÑ ÍµêÏ≤¥Ìï† Ìè¨ÏºìÎ™¨Ïùò Ïù∏Îç±Ïä§Î°ú Ïù¥Îèô
        playerParty.Party[0] = newPokemon;
        playerParty.Party[GameManager.Inst.currentMember] = currentBattlePokemon;

        playerUnit.SetUp(newPokemon);
        dialogBox.SetSkillNames(newPokemon.Skills);

        GameManager.Inst.skillCount = newPokemon.Skills.Count;

        yield return dialogBox.TypeDialog($"Í∞ÄÎûè! {newPokemon.P_Base.PokemonName}!");
        GameManager.state = preState;
    }
    [HideInInspector] public bool cancelSelected = false;
    IEnumerator CheckLearnableSkill()
    {
        while (playerUnit.BattlePokemon.CheckForLevelUp())
        {
            playerUnit.BattleHud.SetLevel();
            yield return dialogBox.TypeDialog($"{playerUnit.BattlePokemon.P_Base.PokemonName}{GetCorrectParticle(playerUnit.BattlePokemon.P_Base.PokemonName, "topic")} Î†àÎ≤® {playerUnit.BattlePokemon.PokemonLevel}Î°ú Ïò¨ÎûêÎã§!");

            var newSkill = playerUnit.BattlePokemon.GetLearnableSkill();
            if (newSkill != null)
            {
                if (playerUnit.BattlePokemon.Skills.Count < PokemonBase.MaxNumOfSkills)
                {
                    playerUnit.BattlePokemon.LearnSkill(newSkill);
                    yield return dialogBox.TypeDialog($"{playerUnit.BattlePokemon.P_Base.PokemonName}{GetCorrectParticle(playerUnit.BattlePokemon.P_Base.PokemonName, "topic")} ÏÉàÎ°ú {newSkill.SkillBase.SkillName}{GetCorrectParticle(newSkill.SkillBase.SkillName, "object")} Î∞∞Ïõ†Îã§!");
                    dialogBox.SetSkillNames(playerUnit.BattlePokemon.Skills);
                }
                else
                {
                    bool isFinalDecisionMade = false;
                    while (!isFinalDecisionMade)
                    {
                        yield return dialogBox.TypeDialog($"{playerUnit.BattlePokemon.P_Base.PokemonName}{GetCorrectParticle(playerUnit.BattlePokemon.P_Base.PokemonName, "topic")} ÏÉàÎ°ú {newSkill.SkillBase.SkillName}{GetCorrectParticle(newSkill.SkillBase.SkillName, "object")} Î∞∞Ïö∞Í≥† Ïã∂Ïñ¥ÌïúÎã§!");
                        yield return dialogBox.TypeDialog($"ÌïòÏßÄÎßå Í∏∞Ïà†Ïù¥ 4Í∞úÏù¥ÎØÄÎ°ú Îã§Î•∏ Í∏∞Ïà†ÏùÑ ÏûäÏñ¥Ïïº ÌïúÎã§.");
                        yield return dialogBox.TypeDialog($"{newSkill.SkillBase.SkillName} ÎåÄÏã† Îã§Î•∏ Í∏∞Ïà†ÏùÑ ÏûäÍ≤å ÌïòÍ≤†ÏäµÎãàÍπå?");

                        GameManager.Inst.ConfirmBoxSelection();
                        yield return new WaitUntil(() => GameManager.state != BattleState.ConfirmBox);
                        bool isConfirmed = GameManager.Inst.HandleConfirmBoxSelection();

                        if (isConfirmed)
                        {
                            ChooseSkillToForget(playerUnit.BattlePokemon, newSkill.SkillBase);
                            yield return new WaitUntil(() => GameManager.state == BattleState.Busy);

                            if (cancelSelected || GameManager.Inst.currentSelection == PokemonBase.MaxNumOfSkills)
                            {
                                cancelSelected = false;

                                yield return dialogBox.TypeDialog($"Í∑∏Îüº... {newSkill.SkillBase.SkillName}{GetCorrectParticle(newSkill.SkillBase.SkillName, "object")} Î∞∞Ïö∞Îäî Í≤ÉÏùÑ Ìè¨Í∏∞ÌïòÍ≤†ÏäµÎãàÍπå?");
                                GameManager.Inst.ConfirmBoxSelection();
                                yield return new WaitUntil(() => GameManager.state != BattleState.ConfirmBox);
                                bool giveUp = GameManager.Inst.HandleConfirmBoxSelection();

                                if (giveUp)
                                {
                                    yield return dialogBox.TypeDialog($"{playerUnit.BattlePokemon.P_Base.PokemonName}{GetCorrectParticle(playerUnit.BattlePokemon.P_Base.PokemonName, "topic")} Í≤∞Íµ≠ {newSkill.SkillBase.SkillName}{GetCorrectParticle(newSkill.SkillBase.SkillName, "object")} Î∞∞Ïö∞ÏßÄ ÏïäÏïòÎã§!");
                                    skillToLearn = null;
                                    isFinalDecisionMade = true;
                                }
                                else
                                {
                                    ChooseSkillToForget(playerUnit.BattlePokemon, newSkill.SkillBase);
                                    yield return new WaitUntil(() => GameManager.state == BattleState.SkillToForget);
                                }
                            }
                            else
                            {
                                var oldSkill = playerUnit.BattlePokemon.Skills[GameManager.Inst.currentSelection].SkillBase;
                                playerUnit.BattlePokemon.Skills[GameManager.Inst.currentSelection] = new Skill(newSkill.SkillBase);

                                yield return dialogBox.TypeDialog("1, 2, ... Ïß†!");
                                yield return dialogBox.TypeDialog($"{playerUnit.BattlePokemon.P_Base.PokemonName}{GetCorrectParticle(playerUnit.BattlePokemon.P_Base.PokemonName, "topic")} {oldSkill.SkillName}{GetCorrectParticle(oldSkill.SkillName, "object")} Íπ®ÎÅóÏù¥ ÏûäÏóàÎã§!");
                                yield return dialogBox.TypeDialog($"Í∑∏Î¶¨Í≥† {newSkill.SkillBase.SkillName}{GetCorrectParticle(newSkill.SkillBase.SkillName, "object")} Î∞∞Ïõ†Îã§!");

                                dialogBox.SetSkillNames(playerUnit.BattlePokemon.Skills);
                                skillToLearn = null;
                                isFinalDecisionMade = true;
                            }
                        }
                        else
                        {
                            yield return dialogBox.TypeDialog($"Í∑∏Îüº... {newSkill.SkillBase.SkillName}{GetCorrectParticle(newSkill.SkillBase.SkillName, "object")} Î∞∞Ïö∞Îäî Í≤ÉÏùÑ Ìè¨Í∏∞ÌïòÍ≤†ÏäµÎãàÍπå?");
                            GameManager.Inst.ConfirmBoxSelection();
                            yield return new WaitUntil(() => GameManager.state != BattleState.ConfirmBox);
                            bool isReallyConfirmed = GameManager.Inst.HandleConfirmBoxSelection();

                            if (isReallyConfirmed)
                            {
                                yield return dialogBox.TypeDialog($"{playerUnit.BattlePokemon.P_Base.PokemonName}{GetCorrectParticle(playerUnit.BattlePokemon.P_Base.PokemonName, "topic")} Í≤∞Íµ≠ {newSkill.SkillBase.SkillName}{GetCorrectParticle(newSkill.SkillBase.SkillName, "object")} Î∞∞Ïö∞ÏßÄ ÏïäÏïòÎã§!");
                                skillToLearn = null;
                                isFinalDecisionMade = true;
                            }
                        }
                    }
                }
            }

            yield return playerUnit.BattleHud.SetExpSmooth(true);
        }
    }
    IEnumerator CheckForBattleOver(BattleUnit faintedUnit)
    {
        if (faintedUnit.IsPlayerUnit)
        {
            var nextPokemon = playerParty.GetHealthyPokemon();
            if (nextPokemon != null)
            {
                preState = GameManager.state;
                GameManager.Inst.OpenPartyScreen();
            }
            else
            {
                BattleOver(false);
            }
        }
        else
        {
            //ÏïºÏÉùÌè¨ÏºìÎ™¨
            if (!isTrainerBattle)
            {
                yield return playerParty.CheckForEvolutions();
                yield return new WaitForSeconds(0.5f); // ÏßÑÌôî ÎßàÎ¨¥Î¶¨ ÎåÄÍ∏∞
                BattleOver(true);
            }
            else
            {
                var nextPokemon = trainerParty.GetHealthyPokemon();
                if (nextPokemon != null)
                {
                    //Îã§ÏùåÌè¨ÏºÄ
                    yield return playerParty.CheckForEvolutions();

                }
                else
                {
                    yield return playerParty.CheckForEvolutions();

                    BattleOver(true);
                }
            }
        }
    }
    IEnumerator ShowDamageDetails(DamageDetails damageDetails)
    {
        if (damageDetails.Critical > 1f)
        {
            yield return dialogBox.TypeDialog("Í∏âÏÜåÏóê ÎßûÏïòÎã§!");
        }
        if (damageDetails.TypeEffectiveness > 1)
        {
            if (damageDetails.TypeEffectiveness > 2)
            {
                yield return dialogBox.TypeDialog("Ìö®Í≥ºÍ∞Ä ÍµâÏû•ÌñàÎã§!!");
            }
            else
            {
                yield return dialogBox.TypeDialog("Ìö®Í≥ºÍ∞Ä ÎåÄÎã®ÌñàÎã§!");
            }
        }

        else if (damageDetails.TypeEffectiveness < 1f)
        {
            if (damageDetails.TypeEffectiveness == 0)
            {
                yield return dialogBox.TypeDialog("Ìö®Í≥ºÍ∞Ä ÏóÜÎäî ÎìØ ÌïòÎã§...");
            }
            else
            {
                yield return dialogBox.TypeDialog("Ìö®Í≥ºÍ∞Ä Î≥ÑÎ°úÏù∏ÎìØ ÌïòÎã§...");
            }
        }
    }
    #endregion
    #region Catch
    IEnumerator ThrowPokeball()
    {
        if (isTrainerBattle)
        {
            yield return dialogBox.TypeDialog("Îã§Î•∏ Ìä∏Î†àÏù¥ÎÑàÏùò Ìè¨ÏºìÎ™¨ÏùÄ Ïû°ÏùÑ Ïàò ÏóÜÎã§!");
            GameManager.state = preState;
            yield break;
        }

        var pokeballObj = Instantiate(Pokeball, playerUnit.transform.position, Quaternion.identity);
        var pokeball = pokeballObj.GetComponent<SpriteRenderer>();

        //#34 1254
        //pokeball.transform.DoMove

        int shakeCount = TryToCatchPokemon(enemyUnit.BattlePokemon);
        for (int i = 0; i < Math.Min(shakeCount, 3); ++i)
        {
            yield return new WaitForSeconds(0.5f);
            //ÌùîÎì§Í∏∞ Ïï†ÎãàÎ©îÏù¥ÏÖò
        }
        if (shakeCount == 4)
        {
            //Ïû°Ìûò
            playerParty.AddPokemon(enemyUnit.BattlePokemon);

            GlobalValue.CatchPokemon(enemyUnit.BattlePokemon.P_Base, false);

            Destroy(pokeball);
            yield return dialogBox.TypeDialog($"Ïã†ÎÇúÎã§-!\nÏïºÏÉù {enemyUnit.BattlePokemon.P_Base.PokemonName}ÏùÑ Ïû°ÏïòÎã§!");
            BattleOver(true);
        }
        else
        {
            yield return dialogBox.TypeDialog($"ÏïàÏû°Ìûò!");
            Destroy(pokeball);
            GameManager.state = preState;
        }
        yield return new WaitForSeconds(1.0f);
    }
    int TryToCatchPokemon(Pokemon pokemon)
    {
        float a = (3 * pokemon.MaxHp - 2 * pokemon.PokemonHp) * pokemon.P_Base.CatchRate * ConditionsDB.GetStatusBonus(pokemon.Status) / (3 * pokemon.MaxHp);

        if (a >= 255)
        {
            //ÌùîÎì§Î¶∞ ÌöüÏàò
            return 4;
        }

        float b = 1048560 / Mathf.Sqrt(Mathf.Sqrt(16711680 / a));

        int shakeCount = 0;
        while (shakeCount < 4)
        {
            if (UnityEngine.Random.Range(0, 65535) >= b)
            {
                break;
            }
            ++shakeCount;
        }
        return shakeCount;
    }
    #endregion

    IEnumerator TryToRun()
    {
        if (isTrainerBattle)
        {
            yield return dialogBox.TypeDialog("Ìä∏Î†àÏù¥ÎÑà Î∞∞ÌãÄ Ï§ë ÎèÑÎßù x");
            GameManager.state = preState;
            yield break;
        }

        ++escapeAttempts;
        int playerSpeed = playerUnit.BattlePokemon.Speed;
        int enemySpeed = enemyUnit.BattlePokemon.Speed;

        if (enemySpeed <= playerSpeed)
        {
            yield return dialogBox.TypeDialog("Î¨¥ÏÇ¨Ìûà ÎèÑÎßùÏ≥§Îã§!");
            BattleOver(true);
        }
        else
        {
            float f = (playerSpeed * 128) / (enemySpeed + 30 * escapeAttempts);
            f = f % 256;

            if (UnityEngine.Random.Range(0, 256) < f)
            {
                yield return dialogBox.TypeDialog("Î¨¥ÏÇ¨Ìûà ÎèÑÎßùÏ≥§Îã§!");
                BattleOver(true);
            }
            else
            {
                yield return dialogBox.TypeDialog("ÎèÑÎßùÏπ† Ïàò ÏóÜÏóàÎã§!");
                GameManager.state = preState;
            }
        }
    }


    string GetCorrectParticle(string name, string particleType)    //ÏùÄÎäîÏù¥Í∞Ä
    {
        char lastChar = name[name.Length - 1];
        int unicode = (int)lastChar;
        bool endsWithConsonant = (unicode - 44032) % 28 != 0; // 44032Îäî 'Í∞Ä'Ïùò Ïú†ÎãàÏΩîÎìú, 28Îäî Î∞õÏπ®Ïùò Ïàò


        switch (particleType)
        {
            case "subject": // Ïù¥/Í∞Ä
                { return endsWithConsonant ? "Ïù¥" : "Í∞Ä"; }
            case "topic": // ÏùÄ/Îäî
                { return endsWithConsonant ? "ÏùÄ" : "Îäî"; }
            case "object": // ÏùÑ/Î•º
                { return endsWithConsonant ? "ÏùÑ" : "Î•º"; }
            case "objectTo": // Î°ú/ÏúºÎ°ú
                { return endsWithConsonant ? "Î°ú" : "ÏúºÎ°ú"; }
            default:
                throw new ArgumentException("Invalid particle type");
        }
    }
}
